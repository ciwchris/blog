<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Computer backups</title>
    <meta name="description" content="">
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/prism-base16-monokai.dark.css">
    <link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="Figuring \w+ out">
    <link rel="alternate" href="/feed/feed.json" type="application/json" title="Figuring \w+ out">
    <link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
  </head>
  <body>
    <header>
      <h1 class="home"><a href="/">Figuring \w+ out</a></h1>
      <ul class="nav">
        <li class="nav-item">
          <a href="/about/">About</a>
        </li>
        <li class="nav-item">
          <a href="/pages/">Pages</a>
        </li>
        <li class="nav-item">
          <a href="/feed/feed.xml">RSS</a>
        </li>
      </ul>
      <label class="toggle-switch" for="toggle-input">
          <input id="toggle-input" type="checkbox">
          <span id="dark-icon">üåò</span>
          <span id="light-icon">‚òÄÔ∏è</span>
      </label>
    </header>

    <main class="tmpl-post">
      <h1>Computer backups</h1>

<time datetime="2021-11-13">Nov 13 2021</time><a href="/tags/computer/" class="post-tag">computer</a>

<h3 id="neglect">Neglect <a class="direct-link" href="#neglect">#</a></h3>
<p>I saw the topic of backups come up again on Hacker News. A couple years ago I set up both Duplicacy<br>
and Restic. I was going to run both and then compare them. Instead of setting up a schedule I would<br>
run a script to kick off the backups. I don't remember the details but I found Duplicacy easier to<br>
keep up with so I dropped running Restic fairly quick. I don't remember how long I kept up with the<br>
backups run by Duplicacy but it fail by the wayside at some point. At this point I don't even<br>
remember how I was running them. Considering all of this of course I decided to start all over. This<br>
time I decided to try <a href="https://kopia.io/">Kopia</a>, foolishly believing a new tool will of course fix my issues of<br>
neglecting backups.</p>
<h3 id="getting-started">Getting started <a class="direct-link" href="#getting-started">#</a></h3>
<p>Installation was simple in Arch: <code>yay -S kopia</code>. There are a number of go modules which are<br>
downloaded. I did not see a package for the KopiaUI which was disappointing because I was going for<br>
easy. But the CLI is preferable anyway.</p>
<p>I followed their Getting Started guide. The first example is using the file system. Probably the<br>
simplest use case, so let's try it.</p>
<pre><code>kopia repository create filesystem --path /home/my-user/kopia-backup
kopia snapshot create ~/Documents
</code></pre>
<p>It prompted for a password when creating the repository and then quickly created the snapshot.<br>
Simple indeed. Let's take a look at the snapshot.</p>
<pre><code>kopia snapshot list
</code></pre>
<h3 id="policies">Policies <a class="direct-link" href="#policies">#</a></h3>
<p>I think I want to change some of those policies, like which files to ignore. Let's take a look at<br>
the current default policies.</p>
<pre><code>kopia policy show --global
</code></pre>
<p>First up, lets ignore some directories.</p>
<pre><code>kopia policy set --add-ignore .node_modules/ --global
kopia policy set --add-ignore .git/ --global
kopia policy show --global
</code></pre>
<p>Excellent! I'm was thinking about changing the retention policies but perhaps it's better to keep<br>
the defaults for now, at least on the file system repository. But for reference the command to<br>
change the policy is simple to use.</p>
<pre><code>kopia policy set --keep-monthly 10 --global
</code></pre>
<p>My preference is to use compression though. Maybe not so important for the file system repository<br>
but a feature it will be helpful to try out, hopefully it will help verify I won't have issues<br>
running it on other repositories. The documentation recommends running a benchmark to help determine<br>
which algorithm to use. I tried running the benchmark on a couple files.</p>
<pre><code>kopia benchmark compression --data-file=book.pdf
kopia benchmark compression --data-file=data.csv
</code></pre>
<p>Not much difference in the algorithms for those files. And unsurprisingly it didn't help the PDF.<br>
The CSV isn't very large so not much benefit there either. Oh well, I'll still turn it on and pick<br>
an algorithm.</p>
<pre><code>kopia policy set --compression=pgzip --global
</code></pre>
<p>After enabling it and creating a new snapshot you can view the stats of the snapshot.</p>
<pre><code>kopia content stats
</code></pre>
<blockquote>
<p>compression 1.3%</p>
</blockquote>
<h3 id="scheduling-%F0%9F%93%85">Scheduling üìÖ <a class="direct-link" href="#scheduling-%F0%9F%93%85">#</a></h3>
<p>Okay, well let's put the backups on a schedule so they don't get neglected this time. On Arch one<br>
option is to use <code>systemd-run</code> to run jobs. I'll create a little script to run all snapshots.</p>
<pre><code>echo '#!/bin/sh\nkopia snapshot create --all' &gt;&gt; ~/.bin/kopia-backup.sh
chmod +x ~/.bin/kopia-backup.sh
</code></pre>
<p>Then I'll add an entry to run the script hourly.</p>
<pre><code>systemd-run --user --on-calendar=hourly ~/.bin/kopia-backup.sh
systemctl list-timers
</code></pre>
<h3 id="backblaze">Backblaze <a class="direct-link" href="#backblaze">#</a></h3>
<p>I have an old Backblaze bucket I was using for backups. I'll repurpose it for the Kopia backups.<br>
I'll use environment variables for the Backblaze bucket ID and Key so I can store them elsewhere.</p>
<pre><code>export B2_KEY_ID=MY-APPLICATION-ID
export B2_KEY=MY-APPLICATION-KEY
kopia repository create b2 --bucket=tCarbon
</code></pre>
<p>Policies do need to be set up for this repository as well.</p>
<pre><code>kopia policy set --add-ignore .node_modules/ --global
kopia policy set --add-ignore .git/ --global
kopia policy set --compression=pgzip --global
</code></pre>
<p>Great! And now we can start creating snapshots for this repository.</p>
<pre><code>kopia snapshot create ~/Documents
</code></pre>
<h3 id="switching-repositories">Switching repositories <a class="direct-link" href="#switching-repositories">#</a></h3>
<p>If multiple repositories are being used then you need to switch to the appropriate repository before<br>
taking the snapshot. The command to switch back and forth is the same as the initial command when<br>
creating the repository except the command is <code>connect</code> instead of <code>create</code>.</p>
<pre><code>kopia repository connect filesystem --path /home/ciwchris/kopia-backup
kopia repository connect b2 --bucket=tCarbon
</code></pre>
<h3 id="password-management">Password management <a class="direct-link" href="#password-management">#</a></h3>
<p>The password for the repository will need to be entered when connecting. To provide the password<br>
securely in the script I'm using <a href="https://www.passwordstore.org/">pass</a>. To configure pass I followed <a href="https://gist.github.com/flbuddymooreiv/a4f24da7e0c3552942ff">steps in flbuddymooreiv's<br>
gist</a>.</p>
<ul>
<li>Generate a key to use <code>gpg --gen-key</code></li>
<li>Retrieve the public key <code>gpg --list-keys</code></li>
<li>Use the public key to initialize pass: <code>pass init xxxxxxxxxxx</code></li>
<li>Add Git support to pass: <code>pass git init</code>
<ul>
<li>Git support can be handy when adding a remote repo which then can be shared between devices</li>
</ul>
</li>
<li>Create a password for kopia: <code>pass insert kopia/filesystem</code></li>
</ul>
<p>The backup script can now be modified to insert the password when connecting to the repository. When<br>
the password is accessed a prompt will be displayed to unlock pass. Once the password for pass has<br>
been entered the password will be retrieved and used in the script to connect to the repository.</p>
<pre><code>#!/bin/sh

kopia repository connect filesystem --path /home/ciwchris/kopia-backup -p &quot;$(pass kopia/filesystem)&quot;
kopia snapshot create --all
</code></pre>
<p>Similar steps can be followed to supply the password for connecting to the Backblaze repository as<br>
well as the Backblaze bucket id and key.</p>
<p>That's it for now. Happy backups! ü§û</p>



    </main>

    <footer>
      <ul>
        <li class="nav-item">
          <a href="https://fediverse.christopherlopes.com/chris">üí¨ Fediverse</a>
        </li>
        <li class="nav-item">
          <a href="https://bookshelf.christopherlopes.com">üìö Bookshelf</a>
        </li>
        <li class="nav-item">
          <a href="https://ln.ht/~ciwchris">üîñ Links</a>
        </li>
        <li class="nav-item">
          <a href="https://rss.christopherlopes.com">üìí RSS Reader</a>
        </li>
      </ul>

      ¬©
      <time datetime="2023-03-04">2023</time>
      Chistopher Lopes. I speak only for myself.
    </footer>

    <!-- Current page: /posts/2021-11-13-computer-backups/ -->



  <script>

function setTheme(theme, persist = false) {
    const on = theme;
    const off = theme === 'light' ? 'dark' : 'light'

    const htmlEl = document.documentElement;
    htmlEl.classList.add(on);
    htmlEl.classList.remove(off);

    if (persist) {
        localStorage.setItem('preferred-theme', theme);
    }
}
const toggle = document.getElementById('toggle-input');
const lightIcon = document.getElementById('light-icon');
const darkIcon = document.getElementById('dark-icon');

function updateUI(theme) {
    toggle.checked = theme === 'light';

    if (theme === 'light') {
        lightIcon.style.visibility = "hidden";
        darkIcon.style.visibility = "visible";
    } else {
        darkIcon.style.visibility = "hidden";
        lightIcon.style.visibility = "visible";
    }
}

toggle.addEventListener('click', () => {
    const theme = toggle.checked ? 'light' : 'dark';
    setTheme(theme, true);
    updateUI(theme);
});
const osPreference = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
const preferredTheme = localStorage.getItem('preferred-theme') || osPreference;

setTheme(preferredTheme, false);
updateUI(preferredTheme);
  </script>
  </body>
</html>
