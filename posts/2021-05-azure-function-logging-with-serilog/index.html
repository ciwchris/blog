<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logging Azure Function App log entries using Serilog gotchas</title>
    <meta name="description" content="">
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/prism-base16-monokai.dark.css">
    <link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="Figuring \w+ out">
    <link rel="alternate" href="/feed/feed.json" type="application/json" title="Figuring \w+ out">
    <link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
  </head>
  <body>
    <header>
      <h1 class="home"><a href="/">Figuring \w+ out</a></h1>
      <ul class="nav">
        <li class="nav-item">
          <a href="/about/">About</a>
        </li>
        <li class="nav-item">
          <a href="/pages/">Pages</a>
        </li>
        <li class="nav-item">
          <a href="/feed/feed.xml">RSS</a>
        </li>
      </ul>
      <label class="toggle-switch" for="toggle-input">
          <input id="toggle-input" type="checkbox">
          <span id="dark-icon">üåò</span>
          <span id="light-icon">‚òÄÔ∏è</span>
      </label>
    </header>

    <main class="tmpl-post">
      <h1>Logging Azure Function App log entries using Serilog gotchas</h1>

<time datetime="2021-05-28">May 28 2021</time><a href="/tags/azure-fuctions/" class="post-tag">azure fuctions</a><a href="/tags/logging/" class="post-tag">logging</a>

<h3 id="the-problem">The problem <a class="direct-link" href="#the-problem">#</a></h3>
<p>Azure Functions are great, except logging configuration is not the same as .Net Core applications and there are a number of ways logging can be configured incorrectly which leads to unexpected behavior. One such scenario I recently experienced was sending the Function App logs to Serilog. This was accomplished in start up using the <code>AddLogging</code> extension method.</p>
<pre class="language-csharp"><code class="language-csharp">Log<span class="token punctuation">.</span>Logger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">LoggerConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span>WriteTo<span class="token punctuation">.</span><span class="token function">Console</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">CreateLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>builder<span class="token punctuation">.</span>Services<br>    <span class="token punctuation">.</span><span class="token function">AddSingleton</span><span class="token punctuation">(</span>Log<span class="token punctuation">.</span>Logger<span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">AddLogging</span><span class="token punctuation">(</span>loggingBuilder <span class="token operator">=></span> loggingBuilder<span class="token punctuation">.</span><span class="token function">AddSerilog</span><span class="token punctuation">(</span><span class="token named-parameter punctuation">dispose</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>This seemingly worked. Maybe. There appeared to be missing log entries at times, they never made it to the sink, so maybe not. This was not investigated further because what we did find was the Function App Information level logging is noisy. We therefore adjusted the log level by updating <code>host.json</code>.</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span><br>    <span class="token property">"logging"</span><span class="token operator">:</span> <span class="token punctuation">{</span><br>        <span class="token property">"default"</span><span class="token operator">:</span> <span class="token string">"Warning"</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>However, this didn't seem to make any impact. Function App Information level logs were still being written to the sink.</p>
<h3 id="the-resolution">The resolution <a class="direct-link" href="#the-resolution">#</a></h3>
<p>There is a question similar to the problem we experience posted on <a href="https://stackoverflow.com/a/67225369">Stack Overflow with a helpful answer</a>. The reason is not clear, just hints and warnings about when and how logging is used in start up. Instead of using the <code>AddLogging</code> extension method registering an <code>ILoggerProvider</code> is suggested.</p>
<pre class="language-csharp"><code class="language-csharp">Log<span class="token punctuation">.</span>Logger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">LoggerConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span>WriteTo<span class="token punctuation">.</span><span class="token function">Console</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">CreateLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>builder<span class="token punctuation">.</span>Services<br>    <span class="token punctuation">.</span><span class="token function">AddSingleton</span><span class="token punctuation">(</span>Log<span class="token punctuation">.</span>Logger<span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ILoggingProvider<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Serilog<span class="token punctuation">.</span>Extensions<span class="token punctuation">.</span>Logging<span class="token punctuation">.</span>SerilogLoggerProvider</span><span class="token punctuation">(</span>Log<span class="token punctuation">.</span>Logger<span class="token punctuation">,</span> <span class="token named-parameter punctuation">dispose</span><span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>This worked as expected! Thank you <a href="https://stackoverflow.com/users/6345585/martin-cerny">Martin Cerny</a>!</p>
<h3 id="next-problem">Next problem <a class="direct-link" href="#next-problem">#</a></h3>
<p>The Function App logging was no longer noisy, but sometimes it is nice to change the log level and receive lower level log entries. How can this be accomplished without deploying a new version of the Function App?</p>
<h3 id="next-solution">Next solution <a class="direct-link" href="#next-solution">#</a></h3>
<p>Azure Functions provide a convenient way of <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-host-json#override-hostjson-values">overriding values in the host file</a>. We can therefore use this mechanism to change the log level by adding an Application Setting:</p>
<pre><code>AzureFunctionsJobHost__logging__default: Information
</code></pre>
<p>We once again receive Information level events coming from the Function App. The one drawback to this is that the Function App will be restarted when an Application Setting is added or changed.</p>



    </main>

    <footer>
      ¬©
      <time datetime="2023-01-02">2023</time>
      Chistopher Lopes. I speak only for myself.
    </footer>

    <!-- Current page: /posts/2021-05-azure-function-logging-with-serilog/ -->



  <script>

function setTheme(theme, persist = false) {
    const on = theme;
    const off = theme === 'light' ? 'dark' : 'light'

    const htmlEl = document.documentElement;
    htmlEl.classList.add(on);
    htmlEl.classList.remove(off);

    if (persist) {
        localStorage.setItem('preferred-theme', theme);
    }
}
const toggle = document.getElementById('toggle-input');
const lightIcon = document.getElementById('light-icon');
const darkIcon = document.getElementById('dark-icon');

function updateUI(theme) {
    toggle.checked = theme === 'light';

    if (theme === 'light') {
        lightIcon.style.visibility = "hidden";
        darkIcon.style.visibility = "visible";
    } else {
        darkIcon.style.visibility = "hidden";
        lightIcon.style.visibility = "visible";
    }
}

toggle.addEventListener('click', () => {
    const theme = toggle.checked ? 'light' : 'dark';
    setTheme(theme, true);
    updateUI(theme);
});
const osPreference = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
const preferredTheme = localStorage.getItem('preferred-theme') || osPreference;

setTheme(preferredTheme, false);
updateUI(preferredTheme);
  </script>
  </body>
</html>
